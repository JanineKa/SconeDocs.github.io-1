<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>SCONE Tutorial - SCONE</title>
  

  <link rel="shortcut icon" href="../img/favicon.ico">

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../css/highlight.css">

  
  <script>
    // Current page data
    var mkdocs_page_name = "SCONE Tutorial";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js"></script>
  <script src="../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../js/highlight.pack.js"></script>
  <script src="../js/theme.js"></script> 

  
  <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-103149717-2', 'sconedocs.github.io');
      ga('send', 'pageview');
  </script>
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> SCONE</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        <ul class="current">
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="..">Introduction</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../outline/">Getting Started</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../appsecurity/">Application-oriented security</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../background/">SCONE Background</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../SCONE_CLI/">SCONE CLI</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../SCONE_HOSTINSTALLER_README/">SCONE Host Setup</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../SCONE_COMPILER_CONTAINER_README/">SCONE SGX toolchain</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../SCONE_Curated_Images/">SCONE Curated Images</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 current">
        <a class="current" href="./">SCONE Tutorial</a>
        
            <ul>
            
                <li class="toctree-l3"><a href="#scone-tutorial">SCONE Tutorial</a></li>
                
                    <li><a class="toctree-l4" href="#prerequisites">Prerequisites</a></li>
                
                    <li><a class="toctree-l4" href="#install-the-tutorial">Install the tutorial</a></li>
                
                    <li><a class="toctree-l4" href="#native-hello-world">Native Hello World</a></li>
                
                    <li><a class="toctree-l4" href="#statically-linked-hello-world">Statically-Linked Hello World</a></li>
                
                    <li><a class="toctree-l4" href="#dynamically-linked-hello-world">Dynamically-Linked Hello World</a></li>
                
                    <li><a class="toctree-l4" href="#run-strace">Run STRACE</a></li>
                
                    <li><a class="toctree-l4" href="#screencast">Screencast</a></li>
                
            
            </ul>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../SCONE_GENERATE_IMAGE/">SCONE Create Image</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../SCONE_Dockerfile/">SCONE Dockerfile</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../SCONE_Swarm/">SCONE Swarm</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../SCONE_Swarm_Example/">SCONE Swarm Example</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../SCONE_Fileshield/">SCONE File Protection</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../Python/">Python</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../GO/">GO</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../SCONE_Publications/">SCONE Publications</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../glossary/">Glossary</a>
        
    </li>
<li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">SCONE</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>SCONE Tutorial</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="scone-tutorial">SCONE Tutorial</h1>
<h2 id="prerequisites">Prerequisites</h2>
<h3 id="ensure-that-the-sgx-driver-is-installed">Ensure that the sgx driver is installed</h3>
<pre><code class="bash">ls /dev/isgx 
/dev/isgx
</code></pre>

<p>If the driver is not installed, read Section <a href="../SCONE_HOSTINSTALLER_README/">SCONE Host Setup</a> to learn how to install the SGX driver.</p>
<h3 id="install-sgxmusl-cross-compiler-image">Install sgxmusl cross compiler image</h3>
<p>Ensure that you installed the various sconecuratedimages/crosscompilers container image:</p>
<pre><code class="bash">docker image ls sconecuratedimages/*
REPOSITORY                          TAG                    IMAGE ID            CREATED             SIZE
sconecuratedimages/crosscompilers   latest                 dff7975b7f32        7 hours ago         1.57GB
sconecuratedimages/crosscompilers   scone                  dff7975b7f32        7 hours ago         1.57GB
</code></pre>

<p>If the cross compiler image is not yet installed, read Section <a href="../SCONE_Curated_Images/">SCONE Curated Container Images</a> to learn how to install the SCONE cross compiler image.</p>
<p>If the docker command fails, please ensure that docker is indeed installed (see <a href="../SCONE_HOSTINSTALLER_README/">SCONE Host Setup</a>. Also, on some systems you might need to use <em>sodo</em> to run docker commands.</p>
<h2 id="install-the-tutorial">Install the tutorial</h2>
<p>Clone the tutorial:</p>
<pre><code class="bash">git clone https://github.com/christoffetzer/SCONE_TUTORIAL.git
</code></pre>

<h2 id="native-hello-world">Native Hello World</h2>
<p>Ensure that <em>hello world</em> runs natively on your machine:</p>
<pre><code class="bash">cd SCONE_TUTORIAL/HelloWorld/
gcc hello_world.c  -o native_hello_world
./native_hello_world
Hello World
</code></pre>

<p>Note that the generated executable, i.e., <em>sim_hello_world</em>, will only run on Linux.</p>
<h2 id="statically-linked-hello-world">Statically-Linked Hello World</h2>
<p>The default cross compiler variant that runs <em>hello world</em> inside of an enclave is <em>scone gcc</em> and you can find this in container <em>sconecuratedimages/crosscompilers:scone</em>.
This variant requires access to the SGX device. 
In Linux, the SGX device is made available as <em>/dev/isgx</em> and we can give the cross compiler inside of an container access via option <em>--device=/dev/isgx</em>:</p>
<pre><code class="bash">docker run --rm --device=/dev/isgx -v &quot;$PWD&quot;:/usr/src/myapp -w /usr/src/myapp sconecuratedimages/crosscompilers:scone scone-gcc hello_world.c  -o sgx_hello_world
</code></pre>

<p>This generates a statically linked binary:</p>
<pre><code class="bash">ldd sgx_hello_world
    not a dynamic executable
</code></pre>

<p>Ensure that file <em>/etc/sgx-musl.conf</em> exists. If not, store default file:</p>
<pre><code class="bash">sudo printf 'Q 1\ne 0 0 0\ns 1 0 0\n' &gt; /etc/sgx-musl.conf
</code></pre>

<p>To run <em>sgx_hello_world</em>, in an enclave, just execute:</p>
<pre><code class="bash">./sgx_hello_world
Hello World
</code></pre>

<p>To see some more debug messages, set environment variable <em>SCONE_VERSION=1</em>:</p>
<pre><code class="bash">SCONE_VERSION=1 ./sgx_hello_world
export SCONE_QUEUES=4
export SCONE_SLOTS=256
export SCONE_SIGPIPE=0
export SCONE_MMAP32BIT=0
export SCONE_SSPINS=100
export SCONE_SSLEEP=4000
export SCONE_KERNEL=0
export SCONE_HEAP=67108864
export SCONE_CONFIG=/etc/sgx-musl.conf
export SCONE_MODE=hw
Configure parameters: 
1.1.15
Hello World
</code></pre>

<p>The debug outputs <strong>SCONE_MODE=hw</strong> shows that <em>sgx_hello_world</em> runs in hardware mode, i.e., inside an SGX enclave.</p>
<p><strong>Note.</strong> The compilation as well as the hello world program will fail in case you do not have an SGX driver installed.</p>
<h2 id="dynamically-linked-hello-world">Dynamically-Linked Hello World</h2>
<pre><code class="bash">docker run --rm  -v &quot;$PWD&quot;:/usr/src/myapp -w /usr/src/myapp sconecuratedimages/muslgcc gcc  hello_world.c -o dyn_hello_world
</code></pre>

<p>To run this natively, just execute the following:</p>
<pre><code class="bash">docker run --rm  -v &quot;$PWD&quot;:/usr/src/myapp -w /usr/src/myapp sconecuratedimages/muslgcc ./dyn_hello_world
</code></pre>

<p>To run a dynamically-linked binary in an enclave, you need to run this in a special runtime environment. In this environment you can ask binaries to run inside of enclaves by setting environment <em>SCONE_ALPINE=1</em>. To indicate that we are indeed running inside an enclave, we ask to issue some debug messages from inside the enclave by setting environment variable <em>SCONE_VERSION=1</em>:</p>
<h3 id="hardware-mode-vs-simulation-mode">Hardware Mode vs Simulation Mode</h3>
<p>For debugging, we support three different modes for execution: <em>hardware, simulation, and automatic</em>:</p>
<ul>
<li>
<p><em>hardware</em>: by setting environment variable to <strong>SCONE_MODE=HW</strong>, SCONE will enforce running this application inside an SGX enclave.</p>
</li>
<li>
<p><em>simulation</em>: by setting environment variable to <strong>SCONE_MODE=SIM</strong>, SCONE will enforce running this application in native mode (i.e., outside of an enclave). This will run all SCONE functionality but outside enclaves. This is intended for development and debugging on machines that are not SGX-capable.</p>
</li>
<li>
<p><em>automatic</em>: by setting environment variable to <strong>SCONE_MODE=AUTO</strong>, SCONE will run the application inside of an SGX enclave if available and otherwise in simulation mode. (This is the default mode)</p>
</li>
</ul>
<p><strong>NOTE</strong>: In production mode, you must only permit running in hardware mode. Scone ensures this with the help of <em>remote attestation</em>: the SCONE configuration and attestation service (CAS) will only provide configuration information and secrets to an application only after it has proven (with the help of SGX CPU extensions) that it is indeed running inside an SGX enclave.</p>
<h3 id="execution-on-a-sgx-capable-machine">Execution on a SGX-capable machine</h3>
<pre><code class="bash">docker run --rm  -v &quot;$PWD&quot;:/usr/src/myapp -e SCONE_MODE=HW -e SCONE_ALPINE=1 -e SCONE_VERSION=1 sconecuratedimages/crosscompilers:runtime /usr/src/myapp/dyn_hello_world
export SCONE_QUEUES=4
export SCONE_SLOTS=256
export SCONE_SIGPIPE=0
export SCONE_MMAP32BIT=0
export SCONE_SSPINS=100
export SCONE_SSLEEP=4000
export SCONE_KERNEL=0
export SCONE_HEAP=67108864
export SCONE_CONFIG=/etc/sgx-musl.conf
export SCONE_MODE=hw
Configure parameters: 
1.1.15
Hello World
</code></pre>

<h3 id="execution-on-a-non-sgx-machine">Execution on a non-SGX machine</h3>
<p>If you run this inside a container without access to SGX (/dev/isgx), for example, when running on a Mac, you will see the following error message:</p>
<pre><code class="bash">docker run --rm  -v &quot;$PWD&quot;:/usr/src/myapp -e SCONE_MODE=HW -e SCONE_ALPINE=1 -e SCONE_VERSION=1 sconecuratedimages/crosscompilers:runtime /usr/src/myapp/dyn_hello_world
[Error] Could not create enclave: Error opening SGX device
</code></pre>

<p>You could run this in simulation mode as follows:</p>
<pre><code class="bash">docker run --rm  -v &quot;$PWD&quot;:/usr/src/myapp -e SCONE_MODE=SIM -e SCONE_ALPINE=1 -e SCONE_VERSION=1 sconecuratedimages/crosscompilers:runtime /usr/src/myapp/dyn_hello_world
export SCONE_QUEUES=4
export SCONE_SLOTS=256
export SCONE_SIGPIPE=0
export SCONE_MMAP32BIT=0
export SCONE_SSPINS=100
export SCONE_SSLEEP=4000
export SCONE_KERNEL=0
export SCONE_HEAP=67108864
export SCONE_CONFIG=/etc/sgx-musl.conf
export SCONE_MODE=sim
Configure parameters: 
1.1.15
Hello World
</code></pre>

<p>Alternatively, you could run this program in automatic mode:</p>
<pre><code class="bash">docker run --rm  -v &quot;$PWD&quot;:/usr/src/myapp -e SCONE_MODE=AUTO -e SCONE_ALPINE=1 -e SCONE_VERSION=1 sconecuratedimages/crosscompilers:runtime 
export SCONE_QUEUES=4
export SCONE_SLOTS=256
export SCONE_SIGPIPE=0
export SCONE_MMAP32BIT=0
export SCONE_SSPINS=100
export SCONE_SSLEEP=4000
export SCONE_KERNEL=0
export SCONE_HEAP=67108864
export SCONE_CONFIG=/etc/sgx-musl.conf
export SCONE_MODE=sim
Configure parameters:
1.1.15
HelloWorld
</code></pre>

<h2 id="run-strace">Run STRACE</h2>
<p>Lets see how we can trace the program. Say, you have compile the program as shown above. After that you enter a cross compiler container and strace hello world as follows:</p>
<pre><code class="bash">docker run --cap-add SYS_PTRACE -it --rm --device=/dev/isgx -v &quot;$PWD&quot;:/usr/src/myapp -w /usr/src/myapp sconecuratedimages/crosscompilers strace  -f /usr/src/myapp/sgx_hello_world &gt; strace.log
Hello World
head strace.log
execve(&quot;/usr/src/myapp/sgx_hello_world&quot;, [&quot;/usr/src/myapp/sgx_hello_world&quot;], [/* 10 vars */]) = 0
brk(NULL)                               = 0x10e8000
access(&quot;/etc/ld.so.nohwcap&quot;, F_OK)      = -1 ENOENT (No such file or directory)
mmap(NULL, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7f17f07f1000
access(&quot;/etc/ld.so.preload&quot;, R_OK)      = -1 ENOENT (No such file or directory)
open(&quot;/etc/ld.so.cache&quot;, O_RDONLY|O_CLOEXEC) = 3
fstat(3, {st_mode=S_IFREG|0644, st_size=18506, ...}) = 0
mmap(NULL, 18506, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7f17f07ec000
close(3)                                = 0
access(&quot;/etc/ld.so.nohwcap&quot;, F_OK)      = -1 ENOENT (No such file or directory)
</code></pre>

<h2 id="screencast">Screencast</h2>
<p><a href="https://asciinema.org/a/Qq3TvvFkRndWstBNsP0TnMAdZ"><img alt="asciicast" src="https://asciinema.org/a/Qq3TvvFkRndWstBNsP0TnMAdZ.png" /></a></p>
<p>Author: Christof Fetzer, November 2017</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../SCONE_GENERATE_IMAGE/" class="btn btn-neutral float-right" title="SCONE Create Image"/>Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../SCONE_Curated_Images/" class="btn btn-neutral" title="SCONE Curated Images"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>

  </div>

<div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../SCONE_Curated_Images/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../SCONE_GENERATE_IMAGE/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>

</body>
</html>
