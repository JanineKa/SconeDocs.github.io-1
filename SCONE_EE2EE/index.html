<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Example E2E encryption - SCONE</title>
  

  <link rel="shortcut icon" href="../img/favicon.ico">

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../css/highlight.css">

  
  <script>
    // Current page data
    var mkdocs_page_name = "Example E2E encryption";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js"></script>
  <script src="../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../js/highlight.pack.js"></script>
  <script src="../js/theme.js"></script> 

  
  <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-103149717-2', 'sconedocs.github.io');
      ga('send', 'pageview');
  </script>
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> SCONE</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        <ul class="current">
          
            <li>
    <ul class="subnav">
    <li><span>Tutorial</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="..">Introduction</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../outline/">Getting Started</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../appsecurity/">Application-oriented security</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../background/">SCONE Background</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../SCONE_CLI/">SCONE CLI</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../SCONE_HOST_SETUP/">SCONE Host Setup</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../SCONE_toolchain/">SCONE SGX toolchain</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../SCONE_Curated_Images/">SCONE Curated Images</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../SCONE_TUTORIAL/">SCONE Tutorial</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../SCONE_GENERATE_IMAGE/">SCONE Create Image</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../SCONE_Dockerfile/">SCONE Dockerfile</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../SCONE_Swarm_Example/">SCONE Swarm Example</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../SCONE_Compose/">SCONE Compose</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../SCONE_CAS/">SCONE CAS</a>
        
    </li>

        
            
    <li class="toctree-l1 current">
        <a class="current" href="./">Example E2E encryption</a>
        
            <ul>
            
                <li class="toctree-l3"><a href="#example-end-to-end-encryption">Example: End-to-End Encryption</a></li>
                
                    <li><a class="toctree-l4" href="#file-encryption">File Encryption</a></li>
                
            
            </ul>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Language Support</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../C/">C</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../C++/">C++</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../Fortran/">Fortran</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../GO/">GO</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../Java/">Java</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../Python/">Python</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../Rust/">Rust</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Manuals</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../SCONE_HOST/">scone host</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../SCONE_SERVICE/">scone service</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../SCONE_STACK/">scone stack</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../SCONE_SWARM/">scone swarm</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../SCONE_VOLUME/">scone volume</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../SCONE_Fileshield/">scone fspf</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Appendix</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../SCONE_ENV/">Environment variables</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../MrEnclave/">MrEnclave</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../ssh/">ssh setup</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../glossary/">Glossary</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../SCONE_Publications/">Publications</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../aboutScone/">About Scone</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../news/">News</a>
        
    </li>

        
    </ul>
<li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">SCONE</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
        
          <li>Tutorial &raquo;</li>
        
      
    
    <li>Example E2E encryption</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="example-end-to-end-encryption">Example: End-to-End Encryption</h1>
<p>We show how to encrypt an application end-to-end, i.e., all the data in the file system is encrypted, all data in main memory is encrypted and all data on the wire is encrypted.</p>
<p>In what follows, we only interact with one swarm. Hence, we set environment variable <strong>SCONE_MANAGER</strong> to point to the manager node of the swarm. Say, in our case the manage is called <strong>faye</strong>:</p>
<pre><code class="bash">$ export SCONE_MANAGER=faye
</code></pre>

<p>We have prepared an nginx image that contains this website as encrypted files and nginx is running inside of an enclave reading the encrypted files
from the file system and decrypting these files inside the enclave.</p>
<p>Let's assume that we have the newest image in our local swarm registry:</p>
<pre><code class="bash">$ scone service pull sconecuratedimages/sconetainer:fss
...
fss: digest: sha256:2e76b4a0b090cc75c2e56594e20c7ec36bc1abd13e36e2f00d36e2f67b13c1d5 size: 1783
new tag: localhost:5000/sconetainer:fss
</code></pre>

<p>We will start this service as a stack. Hence, we define a simple stack/compose file:</p>
<pre><code class="bash">$ cat &gt; compose.yml &lt;&lt; EOF
version: &quot;3.1.scone&quot;
services:
    nginx:
        image: 127.0.0.1:5000/sconetainer:fss
        command: nginx -p /nginx -c nginx.conf
        mrenclave: 1516e3d41590cf3842282c6f037535af64336138a6b5eff7e8754e97b4c64ecb
        fspf_path: /nginx/fspf.pb
        fspf_key: 970f4925bb7b221461f3d1a3f17450aa42844539de24f5acc1b45b8c140f9467
        fspf_tag: 5930bffbd9ea2f1317e6872b032334db
        working_dir: /
        ports:
          - 8190:8080
          - 8192:8082
EOF
</code></pre>

<p>We explain in section <a href="../MrEnclave/">MrEnclave</a> how to determine mrenclave.</p>
<p>For now, this file contains some metadata related to the encrypted files:</p>
<ul>
<li><strong>fspf_path</strong> the path of the <em>file system protection file</em></li>
<li><strong>fspf_key</strong> the key used to encrypt the <em>file system protection file</em></li>
<li><strong>fspf_tag</strong> the tag (i.e., MAC) of the <em>file system protection file</em></li>
</ul>
<p>We provide a low level for encrypting files with the help of <a href="../SCONE_Fileshield/">scone fspf</a>. (We will soon release a higher level support that will simplify the encryption of files). </p>
<p>In this swarm, we have a CAS (Configuration and Attestation Service running): the CAS helps
us to to pass some secrets like the <strong>fspf_key</strong> to an enclave and protecting both
the confidentiality as well as the integrity of this secret.</p>
<p>Clients can identify the CAS via its certificate. In this example,
we explicitly specify the certificate of the CAS:</p>
<pre><code class="bash">$ cat &gt; ca.pem &lt;&lt; EOF
-----BEGIN CERTIFICATE-----
MIICKDCCAc2gAwIBAgIJAMnmUBMT+gOGMAoGCCqGSM49BAMCMHAxCzAJBgNVBAYT
AlVTMQ8wDQYDVQQIDAZPcmVnb24xETAPBgNVBAcMCFBvcnRsYW5kMRUwEwYDVQQK
DAxDb21wYW55IE5hbWUxDDAKBgNVBAsMA09yZzEYMBYGA1UEAwwPd3d3LmV4YW1w
bGUuY29tMB4XDTE3MDQwNzEzNTIyMloXDTE4MDQwNzEzNTIyMlowcDELMAkGA1UE
BhMCVVMxDzANBgNVBAgMBk9yZWdvbjERMA8GA1UEBwwIUG9ydGxhbmQxFTATBgNV
BAoMDENvbXBhbnkgTmFtZTEMMAoGA1UECwwDT3JnMRgwFgYDVQQDDA93d3cuZXhh
bXBsZS5jb20wWTATBgcqhkjOPQIBBggqhkjOPQMBBwNCAARvkkSOfCGXIyWCCdfj
Mil6dhw/a2ZsPaBKOl1RS5MZuoN+7gtSqgnaT5KrT4S/Wj7flP+PJqkUf0M6p1gg
E5wBo1AwTjAdBgNVHQ4EFgQUzPP33ZM7ZMQ7UDb9THNM5Yoma3YwHwYDVR0jBBgw
FoAUzPP33ZM7ZMQ7UDb9THNM5Yoma3YwDAYDVR0TBAUwAwEB/zAKBggqhkjOPQQD
AgNJADBGAiEA34tSQI8V+4UaQG1w7nVJEDLWA17zw5Ls8NZBYVi4lpcCIQDgzln/
1r25fhGzrVbRgAcbmfLsJxuDYpsfAaNL5/5leg==
-----END CERTIFICATE-----
EOF
</code></pre>

<p>and now log into the CAS:</p>
<pre><code class="bash">$ export IP=x.y.z.u
$ mkdir -p ~/.config
$ rm -f ~/.config/scone_cmd.conf
$ scone cas login -c ca.pem christof cas --host $IP:8081:18765
</code></pre>

<p>We split our stack file into two parts: public part sent to the docker engine and a secret part that is directly sent to the CAS:</p>
<pre><code class="bash">$ scone cas split compose.yml  --stack 283299
</code></pre>

<p>Show public part that is sent to <strong>docker stack</strong> (which is the original stack file name appended with "docker.yml"):</p>
<pre><code class="bash">$ cat compose.yml.docker.yml
---
services: 
  nginx: 
    command: nginx
    environment: 
      SCONE_CAS_ADDR: &quot;x.y.z.u:18765&quot;
      SCONE_CONFIG_ID: christof/283299/nginx
      SCONE_LAS_ADDR: &quot;172.17.0.1:18766&quot;
    image: &quot;127.0.0.1:5000/sconetainer:fss&quot;
    ports: 
      - &quot;8190:8080&quot;
      - &quot;8192:8082&quot;
version: &quot;3.1&quot;
</code></pre>

<p>Note: in the above example we assume that the host on which nginx is running is available at address  <strong>172.17.0.1</strong>. Hence, the <strong>LAS</strong> is available at  address <strong>"172.17.0.1:18766</strong>. In case you run a non-standard configuration, you might need to change  <strong>SCONE_LAS_ADDR</strong> to the ip address and port where the LAS  is available. The LAS must run on the same host for the attestation to work.</p>
<p>We can now deploy the service with the help of docker/scone stack:</p>
<pre><code class="bash">$ scone stack deploy --compose-file compose.yml  nginx
Creating network nginx_default
Creating service nginx_nginx
</code></pre>

<p>Show running stack:</p>
<pre><code class="bash">$ scone stack ls
NAME        SERVICES
nginx       1
</code></pre>

<p>We can get some more information about this stack:</p>
<pre><code class="bash">$ scone stack ps nginx
ID                  NAME                IMAGE                            NODE                DESIRED STATE       CURRENT STATE             ERROR                       PORTS
h08r5hmeu9bt        nginx_nginx.1       127.0.0.1:5000/sconetainer:fss   dorothy             Running             Starting 19 seconds ago       
</code></pre>

<h2 id="file-encryption">File Encryption</h2>
<p>Let's check that the files inside of nginx container are indeed encrypted. To do so, we ssh to node  <strong>dorothy</strong> and execute the following commands:</p>
<pre><code class="bash">&gt; sudo docker ps
CONTAINER ID        IMAGE                                    COMMAND                  CREATED             STATUS              PORTS                      NAMES
b01ab65e1579        127.0.0.1:5000/sconetainer:fss           &quot;nginx&quot;                  6 minutes ago       Up 6 minutes        8080/tcp, 8082/tcp         nginx_nginx.1.0wh80346mpmm5f3l1rc8dipix
...
</code></pre>

<p>Let's look inside the container:</p>
<pre><code class="bash">&gt; sudo docker exec -it b01ab65e1579 sh
$ ls
bin             media           proc            srv
dev             mnt             root            sys
etc             nginx           run             tmp
home            nginx-etc       sbin            usr
lib             opt             scone-test.key  var
</code></pre>

<p>The nginx configuration file as well as the html files should be encrypted. Let's verify this:</p>
<pre><code class="bash">$ cd nginx
$ ls
certificate.pem  key.pem          nginx.conf       www_root
fspf.pb          mime.types       nginx.pid
$ head -c 80 nginx.conf
]P?ɟ&quot;4???zS????Ƶ?kjƘ?Ec?!S^!??????8j-?e;?t'?2?L????????y??˲?ߋ   
</code></pre>

<p>Ok, the nginx configuration file seems to be encrypted. Now, look at the html files too:</p>
<pre><code class="bash">$ cd www_root
$ ls 
4K                               SCONE_TUTORIAL
GO                               aboutScone
Python                           appsecurity
...
$ head -c 80 index.html 
????V?ͪ?rhk?&quot;k????$?    .???k?Ь?y&lt;??٠n?+????P2?G;o_'.i?);?I??xFg[???[f?
</code></pre>

<p>&copy; <a href="http://www.scontain.com">scontain.com</a>, December 2017. <a href="mailto:info@scontain.com">Questions or Suggestions?</a></p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../C/" class="btn btn-neutral float-right" title="C"/>Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../SCONE_CAS/" class="btn btn-neutral" title="SCONE CAS"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>

  </div>

<div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../SCONE_CAS/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../C/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>

</body>
</html>
